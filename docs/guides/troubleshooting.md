# Решение проблем (Troubleshooting)

## Обзор

Этот документ содержит решения для наиболее распространенных проблем, с которыми вы можете столкнуться при использовании MetaExpert. Включает в себя диагностику, отладку и рекомендации по устранению неполадок.

## Общие проблемы

### Проблемы с подключением к бирже

#### Описание: "Connection refused" или "Network error"

**Причины:**

- Неправильные настройки сети
- Ограничения брандмауэра
- Временные проблемы с API биржи

**Решения:**

1. Проверьте настройки сети и прокси (если используются)
2. Убедитесь, что API-ключи действительны и имеют необходимые разрешения
3. Проверьте статус API биржи на их официальном сайте
4. Попробуйте использовать другое соединение или VPN

#### Описание: "Rate limit exceeded"

**Причины:**

- Слишком частые запросы к API
- Превышение лимитов, установленных биржей

**Решения:**

1. Реализуйте экспоненциальную задержку между запросами
2. Проверьте и оптимизируйте частоту запросов
3. Используйте асинхронные вызовы для более эффективного использования соединений

### Проблемы с аутентификацией

#### Описание: "Invalid API key" или "Authentication failed"

**Причины:**

- Неправильные или устаревшие API-ключи
- Неверные настройки подписи запросов

**Решения:**

1. Проверьте API-ключи в настройках биржи
2. Убедитесь, что ключи правильно скопированы в файл `.env`
3. Проверьте, что ключи имеют необходимые разрешения (только для чтения, торговля и т.д.)
4. Пересоздайте API-ключи при необходимости

## Проблемы с логированием

### Логи не создаются или отсутствуют

#### Описание: Файлы логов не создаются или остаются пустыми

**Причины:**

- Неправильная конфигурация логирования
- Ошибки при инициализации системы логирования
- Недостаточные права доступа к директории логов

**Решения:**

1. Проверьте, что `setup_logging()` вызывается при запуске приложения:

   ```python
   from metaexpert.logger import setup_logging, LoggerConfig
   
   config = LoggerConfig(log_to_file=True)
   setup_logging(config)
   ```

2. Убедитесь, что директория для логов существует и доступна для записи:

   ```python
   from pathlib import Path
   
   log_dir = Path("logs")
   log_dir.mkdir(parents=True, exist_ok=True)
   ```

3. Проверьте уровень логирования - возможно, сообщения фильтруются из-за слишком высокого порога

#### Описание: Логи создаются, но не содержат ожидаемой информации

**Причины:**

- Неправильная настройка процессоров или форматтеров
- Неверно настроенный контекст логирования

**Решения:**

1. Проверьте конфигурацию `LoggerConfig`:
   - Убедитесь, что `log_to_file` или `log_to_console` установлены в `True`
   - Проверьте уровень логирования
2. Убедитесь, что используете правильный логгер:

   ```python
   from metaexpert.logger import get_logger
   
   logger = get_logger(__name__)
   logger.info("test message")  # Уровень INFO должен быть выше уровня конфигурации
   ```

### Проблемы с форматом логов

#### Описание: Логи содержат непонятные или нечитаемые данные

**Причины:**

- Неправильная настройка форматтеров
- Использование неподходящего формата (JSON vs человекочитаемый)

**Решения:**

1. Для разработки используйте читаемый формат:

   ```python
   config = LoggerConfig(
       json_logging=False,  # Человекочитаемый формат
       use_colors=True   # Цветной вывод
   )
   ```

2. Для продакшена рекомендуется использовать JSON:

   ```python
   config = LoggerConfig(
       json_logging=True,   # JSON формат для продакшена
       use_colors=False # Без цветов
   )
   ```

### Проблемы с контекстным логированием

#### Описание: Контекст не передается в логи должным образом

**Причины:**

- Неправильное использование контекстных менеджеров
- Проблемы с переменными контекста

**Решения:**

1. Используйте `LogContext` для временного контекста:

   ```python
   from metaexpert.logger import LogContext, get_logger
   
   logger = get_logger(__name__)
   
   with LogContext(strategy_id=1001, symbol="BTCUSDT"):
       logger.info("executing strategy")  # Содержит strategy_id и symbol
   ```

2. Для постоянного контекста используйте `bind`:

   ```python
   logger = get_logger(__name__).bind(
       exchange="binance",
       market_type="futures"
   )
   ```

### Проблемы с фильтрацией чувствительных данных

#### Описание: Чувствительные данные все еще видны в логах

**Причины:**

- Неправильные имена полей, содержащих чувствительные данные
- Пропуск валидации через `SensitiveDataFilter`

**Решения:**

1. Убедитесь, что ключи чувствительных данных соответствуют ожидаемым:

   ```python
   # Эти ключи автоматически фильтруются:
   logger.info("api call", api_key="secret12345")    # Будет замаскирован
   logger.info("auth", token="mytoken12345")         # Будет замаскирован
   logger.info("connect", password="mypass")         # Будет замаскирован
   ```

2. Проверьте, что `SensitiveDataFilter` включен в цепочке процессоров (он включен по умолчанию)

### Проблемы с производительностью логирования

#### Описание: Логирование замедляет приложение

**Причины:**

- Чрезмерное логирование на уровне DEBUG в продакшене
- Синхронная запись в файлы
- Слишком много данных в логах

**Решения:**

1. Настройте уровень логирования в зависимости от среды:

   ```python
   # В продакшене используйте WARNING или ERROR
   config = LoggerConfig.for_production()
   # В разработке можно использовать DEBUG
   config = LoggerConfig.for_development()
   ```

2. Оптимизируйте структуру логов, убрав избыточную информацию
3. Используйте асинхронные обработчики при необходимости

## Проблемы с конфигурацией

### Ошибки валидации конфигурации

#### Описание: `ValidationError` при создании `LoggerConfig`

**Причины:**

- Недопустимые значения параметров конфигурации
- Нарушение ограничений валидации

**Решения:**

1. Проверьте значения параметров:
   - `max_bytes` не должен превышать 1GB
   - `log_dir` должен быть доступен для записи
   - Должен быть включен хотя бы один метод вывода (консоль или файл)
2. Используйте предустановленные пресеты:

   ```python
   from metaexpert.logger import LoggerConfig
   
   # Вместо ручной настройки используйте пресеты
   config = LoggerConfig.for_development()
   config = LoggerConfig.for_production()
   config = LoggerConfig.for_backtesting()
   ```

## Диагностика и отладка

### Включение отладочного режима

Для диагностики проблем включите подробное логирование:

```python
from metaexpert.logger import setup_logging, LoggerConfig

# Для диагностики используйте отладочный уровень
config = LoggerConfig(
    log_level="DEBUG",
    log_to_console=True,
    use_colors=True
)
setup_logging(config)
```

### Проверка состояния системы логирования

Для проверки корректности настройки логирования:

```python
from metaexpert.logger import get_logger

logger = get_logger(__name__)
logger.info("Test log message", test_param="value")
# Проверьте, появляется ли это сообщение в ожидаемом месте
```

## Поддержка и ресурсы

Если вы столкнулись с проблемой, не описанной в этом документе:

1. Проверьте существующие [issues](https://github.com/teratron/metaexpert/issues) в репозитории
2. Создайте новое issue с подробным описанием проблемы
3. Приложите соответствующие логи (убедитесь, что они не содержат чувствительной информации)
4. Укажите версию MetaExpert, Python и используемую ОС
